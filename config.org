* Fixes
** init
   #+BEGIN_SRC emacs-lisp :tangle yes
   (require 'package)
   (let* ((no-ssl (and (memq system-type '(windows-nt ms-dos))
		       (not (gnutls-available-p))))
	  (proto (if no-ssl "http" "https")))
     (add-to-list 'package-archives (cons "melpa" (concat proto "://melpa.org/packages/")) t)
     (add-to-list 'package-archives (cons "melpa-stable" (concat proto "://stable.melpa.org/packages/")) t)
     (package-initialize))

   (unless (package-installed-p 'use-package)
     (package-refresh-contents)
     (package-install 'use-package))


   (set-frame-font "Fira Code-12" nil t)
   (load-file (expand-file-name "~/.emacs.d/elisp/utilties.el"))
   #+END_SRC
** evil-mode
   #+BEGIN_SRC emacs-lisp :tangle yes
   (use-package evil-leader
     :ensure t
     :custom
     (evil-want-integration t)
     (evil-want-keybinding nil)
     :init
     (global-evil-leader-mode)
     (evil-leader/set-leader "<SPC>"))

   (use-package evil-collection
     :ensure t
     :custom
     (evil-collection-company-use-tng nil)
     :init
     (evil-collection-init))

   (use-package evil
     :ensure t
     :after evil-leader
     :bind
     (:map evil-normal-state-map
	   ("Â´" . 'evil-goto-mark)
	   ("C-e" . 'merge-buffer)
	   ("," . 'evil-goto-mark))
     :config
     (evil-mode 1)
     (evil-leader/set-key
       ;; buffers & windows
       "b b" 'helm-buffers-list
       "b o" 'other-buffer
       "b i" 'ibuffer
       "o" 'other-window
       "q" 'kill-buffer

       ;; misc
       "a" 'comment-dwim
       "i" 'indent-region
       "w" '(lambda () (interactive)
	      (paredit-mode)
	      (evil-paredit-mode))

       ;;buffer navigation
       "j" 'evil-avy-goto-char

       ;; files
       "f f" 'fzf
       "f d" 'dired-jump
       "f e" '(lambda () (interactive) (find-file "~/.emacs.d/config.org"))
       "f i" '(lambda () (interactive) (find-file "~/.i3/config"))
       "f z" '(lambda () (interactive) (find-file "~/.zshrc"))
       "f n" '(lambda () (interactive)
		(find-file "/etc/nixos/configuration.nix")
		(sudo-edit))

       ;; Projectile stuff
       "p p" 'projectile-find-file-dwim
       "p a" 'projectile-ag
       "p g" 'projectile-vc

       ;;utilities
       "+" 'calc))

   (use-package evil-surround
     :ensure t
     :config
     (global-evil-surround-mode 1))

   (use-package evil-paredit
     :ensure t)
   #+END_SRC
** Basics
#+BEGIN_SRC emacs-lisp :tangle yes
(setq scroll-conservatively 100
      scroll-margin 5
      inhibit-startup-message t
      initial-scratch-message ""
      ring-bell-function 'ignore
      tab-width 2
      display-line-numbers-current-absolute t
      default-directory "/home/bun/"
      tramp-default-method "ssh"
      large-file-warning-threshold nil)

;; sane normal keybinds
(global-set-key (kbd "C-s") 'save-buffer)

(defalias 'yes-or-no-p 'y-or-n-p)
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
(global-display-line-numbers-mode)

;; Load zshrc
(setq shell-file-name "zsh")
(setq shell-command-switch "-ic")

;; File beautification
(setq delete-trailing-lines t)
(add-hook 'before-save-hook 'delete-trailing-whitespace)

;; Electricity!!
(add-hook 'prog-mode-hook 'electric-pair-mode)
;;tmp stuff
(defalias 'sesman-linked-sessions 'sesman--linked-sessions)

;;latex stuff
(setq org-latex-listings 'minted
      org-latex-packages-alist '(("" "minted"))
      org-latex-pdf-process
      '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
        "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f")
      org-export-latex-listings 'minted
      org-src-fontify-natively t)
#+END_SRC
* QOL
  Quality of life packages. many require external software. Look at each package for dependecies
** agressive indent
   #+BEGIN_SRC emacs-lisp :tangle yes
 (use-package aggressive-indent
   :ensure t)
   #+END_SRC
** avy
    #+BEGIN_SRC emacs-lisp :tangle yes
    (use-package avy
      :ensure t)
#+END_SRC
** engine
   used to search web resources.
   #+BEGIN_SRC emacs-lisp :tangle yes
(use-package engine-mode
  :ensure t
  :config
  (defengine cppreference
    "https://en.cppreference.com/mwiki/index.php?search=%s")
  (defengine google
    "https://google.com/search?q=%s")
  (defengine youtube
    "https://www.youtube.com/results?search_query=%s")
  ;; evil keybindings for search eninges
  (evil-leader/set-key
    "s c" 'engine/search-cppreference
    "s g" 'engine/search-google
    "s y" 'engine/search-youtube))
   #+END_SRC
** fzf
    this implementation requires either zplug, or some reconfiguration. See my [[https://github.com/fredeeb/dotfiles][dotfiles]] for more info.
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package fzf
    :ensure t
    :custom
    (fzf/executable "~/.zplug/repos/junegunn/fzf-bin/fzf-bin"))
#+END_SRC
** Hungry delete
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package hungry-delete
    :ensure t
    :config (global-hungry-delete-mode))
#+END_SRC
** iedit
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package iedit
  :ensure t
  :config
  (defhydra hydra-iedit-menu ()
    ("j" iedit-next-occurrence)
    ("k" iedit-prev-occurrence)
    ("q" iedit-quit)
    ("t" iedit-toggle-selection)
    ("f" iedit-restrict-function))
  (evil-leader/set-key
    "m" 'iedit-then-hydra))

(defun iedit-then-hydra ()
  (interactive)
  (iedit-mode)
  (hydra-iedit-menu/body))
#+END_SRC
** openwith
    requires zathura for pdf reading. sxiv for image viewing (not all formats are tested).
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package openwith
    :ensure t
    :config
    (openwith-mode t)
    :custom
    (openwith-associations '(("\\.pdf\\'" "zathura" (file))
                             ("\\.png\\'" "sxiv" (file))
                             ("\\.jpg\\'" "sxiv" (file))
                             ("\\.svg\\'" "sxiv" (file))
                             ("\\.jpeg\\'" "sxiv" (file))
                             ("\\.bmp\\'" "sxiv" (file))
                             ("\\.flac\\'" "mpv" (file))
                             ("\\.mp3\\'" "mpv" (file))
			     ("\\.mp4\\'" "mpv" (file)))))

#+END_SRC
** rainbow
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package rainbow-delimiters
    :ensure t
    :init
    (rainbow-delimiters-mode))
#+END_SRC
** sudo-edit
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package sudo-edit
  :ensure t)
#+END_SRC
* language packs
  mostly syntax higlighters
** matlab
    requires [[https://se.mathworks.com/products/matlab.html][matlab]]
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package matlab-mode
    :ensure t
    :hook 'matlab-shell
    :mode ("\\.m\\'" . matlab-mode)
    :custom
    (matlab-indent-function t)
    (matlab-shell-command "matlab"))
#+END_SRC
** csharp
   #+BEGIN_SRC emacs-lisp :tangle yes
   (use-package csharp-mode
     :ensure t)

   (use-package omnisharp
     :ensure t
     :after company
     :config
     (add-hook 'csharp-mode-hook 'omnisharp-mode)
     (add-to-list 'company-backends 'company-omnisharp))
   #+END_SRC
** plant
    requires [[https://plantuml.com][plantuml]]
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package plantuml-mode
    :ensure t
    :custom
    (plantuml-jar-path (expand-file-name (executable-find "plantuml")))
    (org-plantuml-jar-path (replace-regexp-in-string "bin" "lib" (format "%s%s" (expand-file-name (executable-find "plantuml")) ".jar")))
    :magic ("@startuml" . plantuml-mode))

  (use-package flycheck-plantuml
    :ensure t)

  ;; recompiles plantuml diagrams on save
(defun recompile-plantuml ()
  (add-hook 'after-save-hook
	    (lambda () (call-process "plantuml" nil nil nil (buffer-name)))))

(add-hook 'plantuml-mode-hook 'recompile-plantuml)
#+END_SRC
** textile
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package textile-mode
    :ensure t
    :hook '(textile-mode . visual-line-mode)
    :mode ("\\.textile\\'"))
#+END_SRC
** org stuff
#+BEGIN_SRC emacs-lisp :tangle yes
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t)
     (C . T)
     (plantuml . t)
     (shell . t)
     (python .t)
     (makefile . t)
     (calc . t)
     (matlab . t)
     (emacs-lisp . t)
     (js . t)))

  ;;oxes
  (use-package ox-jira :ensure t)
  (use-package ox-html5slide :ensure t)
  (use-package org-re-reveal :ensure t)
  (use-package ox-textile :ensure t)

  ;; agenda and stuff
  (global-set-key (kbd "C-c l") 'org-store-link)
  (global-set-key (kbd "C-c a") 'org-agenda)
  (global-set-key (kbd "C-c c") 'org-capture)
  (setq org-todo-keywords
	'((sequence "TODO(t)" "WAITING(@/!)" "|" "DONE(d!)")))

  (add-hook 'org-mode-hook 'visual-line-mode)
  (use-package org-ref
    :ensure t)

  (use-package org-bullets
    :ensure t
    :config
    (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))

  (setq org-export-latex-listings 'minted)
  (setq org-src-fontify-natively t)

  (load-file (expand-file-name "~/.emacs.d/elisp/org-macros.el"))

  (use-package org-tree-slide
    :ensure t)

  (defmath uconvert (v u)
    "Convert value V into compatible unit U"
    (math-convert-units v u))

  (use-package polymode
    :ensure t)

  (use-package poly-org
    :ensure t
    :after polymode
    :mode ("//.org//'"))

  (use-package org-brain
    :ensure t
    :config
    (evil-set-initial-state 'org-brain-visualize-mode 'emacs))
#+END_SRC
** yaml
   #+BEGIN_SRC emacs-lisp :tangle yes
(use-package yaml-mode
  :ensure t)
   #+END_SRC
* programming
** company
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package company
    :ensure t
    :init
    (global-company-mode)
    :custom
    (company-global-modes '(prog-mode))
    (company-idle-delay 0)
    (company-minimum-prefix-length 1))
#+END_SRC
** LSP
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package cquery
    :ensure t
    :custom
    (cquery-executable (executable-find "cquery"))
    (cquery-extra-init-params '(:index (:comments 2) :cacheFormat "msgpack"))
    (company-transformers nil)
    (cquery-sem-highlight-method 'font-lock)
    :config
    (evil-leader/set-key
      "r d" 'lsp-ui-peek-find-definitions
      "r i" 'lsp-ui-peek-find-implementation
      "r r" 'lsp-ui-peek-find-references
      "r j" 'lsp-ui-find-next-reference
      "r k" 'lsp-ui-find-prev-reference))

  (use-package lsp-mode
    :ensure t
    :commands lsp
    :config (require 'lsp-clients))

  (use-package lsp-ui
    :ensure t
    :commands lsp-ui-mode)

  (use-package company-lsp
    :ensure t
    :commands company-lsp
    :config
    (push 'company-lsp company-backends))

  (use-package dap-mode
    :ensure t
    :config (require 'dap-lldb))
#+END_SRC
** clojure
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package clojure-mode
  :ensure t
  :config
  (evil-leader/set-key-for-mode 'clojure-mode
    "e" 'cider-eval-last-sexp
    "k" 'cider-eval-buffer))

(use-package cider
  :ensure t
  :custom
  (cider-lein-parameters "repl :headless :host localhost"))

(use-package flycheck-clojure
  :ensure t)

(use-package helm-clojuredocs
  :ensure t)

(use-package cljr-helm
  :ensure t
  :config
  (evil-leader/set-key-for-mode 'cider-mode
    "r h" 'cljr-helm
    "r r" 'cider-eval-last-sexp
    "r k" 'cider-eval-buffer
    "r d" 'helm-clojuredocs))
#+END_SRC
** rust
   #+BEGIN_SRC emacs-lisp :tangle yes
   (use-package cargo
     :ensure t)

   (use-package toml-mode
     :ensure t)

   (add-hook 'rust-mode-hook 'cargo-minor-mode)

   #+END_SRC
** Web
    #+BEGIN_SRC emacs-lisp :tangle yes
    (use-package web-mode
      :ensure t
      :hook
      (html-mode))

    (use-package emmet-mode
      :ensure t
      :bind
      ("M-p" . 'emmet-expand-yas))

    (use-package rainbow-mode
      :ensure t
      :init
      (rainbow-mode 1)
      :hook web-mode)

    (use-package js2-mode
      :ensure t)

    (use-package json-mode
      :ensure t)

#+END_SRC
** yasnippet
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package yasnippet-snippets
    :ensure t)

  (use-package yasnippet
    :ensure t
    :init
    (yas-global-mode 1))
#+END_SRC
* git stuff
   #+BEGIN_SRC emacs-lisp :tangle yes
   (use-package evil-magit
     :ensure t
     :config
     (evil-leader/set-key "g s" 'magit-status)
     :custom
     (magit-repository-directories (expand-file-name "~/git/projects")))

   (use-package git-timemachine
     :ensure t)

   (setenv "SSH_ASKPASS" "git-gui--askpass")

   (use-package ssh-agency
     :ensure t)

   (use-package forge
     :ensure t)

   ;; interactive github functions for extra sauce
   (load-file (expand-file-name "~/.emacs.d/elisp/git-extras.el"))
   #+END_SRC
* ui
** ag
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package ag
  :ensure t)
(use-package helm-ag
  :ensure t)
#+END_SRC
** carbon
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package carbon-now-sh
  :ensure t)
#+END_SRC
** helm
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package helm
  :ensure t
  :config
  (require 'helm-config)
  (helm-mode)
  :bind
  ("C-x C-f" . 'helm-find-files)
  ("C-x C-b" . 'helm-buffers-list)
  ("M-x" . 'helm-M-x))

(use-package helm-make
  :ensure t
  :config
  (evil-leader/set-key "c" 'helm-make))

(use-package helm-company
  :ensure t)

(use-package helm-swoop
  :ensure t
  :bind
  (:map evil-normal-state-map
    ("/" . 'helm-swoop)))

    (use-package helm-xref
      :ensure t)

    (use-package helm-projectile
      :ensure t
      :config
      (evil-leader/set-key
	"p p" 'helm-projectile
	"p f" 'helm-projectile-find-file-dwim
	"p a" 'helm-projectile-ag
	"p s" 'projectile-add-known-project
	"p c" 'projectile-compile-project))
#+END_SRC
** modeline
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package doom-modeline
    :ensure t
    :defer t
    :hook (after-init . doom-modeline-init)
    :custom
    (doom-modeline-buffer-file-name-style 'truncate-with-project))
#+END_SRC
** theme
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package doom-themes
    :ensure t
    :config
    (load-theme 'doom-molokai t))
#+END_SRC
** Which key
#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package which-key
    :ensure t
    :init
    (which-key-mode))
#+END_SRC
** frames only
    for better compatibility with i3
#+BEGIN_SRC emacs-lisp :tangle yes
      (use-package frames-only-mode
        :ensure t
        :config
        (frames-only-mode))
#+END_SRC
** treemacs
   #+BEGIN_SRC emacs-lisp :tangle yes
   (use-package treemacs-evil
     :ensure t
     :config
     (evil-leader/set-key
       "u" 'treemacs
       "t p" 'treemacs-add-project-to-workspace
       "t r" 'treemacs-remove-project-from-workspace))
   #+END_SRC
* nix
#+BEGIN_SRC emacs-lisp :tangle yes
(use-package nix-mode
  :ensure t)

(use-package helm-nixos-options
  :ensure t)

(use-package company-nixos-options
  :ensure t)

(use-package nix-sandbox
  :ensure t)
#+END_SRC
